<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>UseDesk Tools</title>

  <!-- üí´ –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏–Ω–Ω–µ—Ä–∞ -->
  <style>
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ccc;
      border-top: 2px solid #333;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h2>UseDesk –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</h2>

  <button onclick="showForm('ticketFormBlock')">üì© –°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç</button>
  <button onclick="showForm('clientFormBlock')">üë§ –°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
  <button onclick="showForm('updateClientBlock')">üõ†Ô∏è –û–±–Ω–æ–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
  <button onclick="showForm('sendMessageBlock')">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
  <button onclick="showForm('searchClientBlock')">üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞</button>

  <hr>

  <div id="ticketFormBlock">
    <h3>–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞</h3>
    <form id="ticketForm">
      <label>Subject*:</label><br><input type="text" name="subject" required><br><br>
      <label>Message*:</label><br><textarea name="message" rows="4" cols="50" required></textarea><br><br>
      <label>Client Phone (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label><br><input type="text" name="client_phone"><br><br>
      <label>Tag (–Ω–µ –æ–±—è–∑–∞—Ç.):</label><br><input type="text" name="tag"><br><br>

      <label>–ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞:</label><br>
      <select name="user_id">
        <option value="293758">Superuser</option>
        <option value="293880">–î–∏–∞—Å</option>
        <option value="294126">–î–∞—Ä—Ö–∞–Ω</option>
      </select><br><br>

      <label>–¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:</label><br>
      <select name="message_type">
        <option value="public">–ü—É–±–ª–∏—á–Ω—ã–π</option>
        <option value="private">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</option>
      </select><br><br>

      <label>–°—Ç–∞—Ç—É—Å —Ç–∏–∫–µ—Ç–∞:</label><br>
      <select name="status">
        <option value="2">–í—ã–ø–æ–ª–Ω–µ–Ω</option>
        <option value="3">–ó–∞–∫—Ä—ã—Ç</option>
        <option value="6">–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
        <option value="9">–†–∞—Å—Å—ã–ª–∫–∞</option>
      </select><br><br>

      <button type="submit">–°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç</button>
    </form>
    <p id="responseMessage" style="font-weight: bold;"></p>
  </div>

  <div id="clientFormBlock" style="display:none;">
    <h3>–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞</h3>
    <form id="clientForm">
      <label>–ò–º—è:</label><br><input type="text" name="name"><br><br>
      <label>Email:</label><br><input type="email" name="emails"><br><br>
      <label>–ó–∞–º–µ—Ç–∫–∏:</label><br><input type="text" name="note"><br><br>
      <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label><br><input type="text" name="phone"><br><br>
      <button type="submit">–°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
    </form>
    <p id="clientResponse" style="font-weight: bold;"></p>
  </div>

  <div id="updateClientBlock" style="display:none;">
    <h3>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞</h3>
    <form id="updateForm">
      <label>ID –∫–ª–∏–µ–Ω—Ç–∞:</label><br><input type="text" name="client_id"><br><br>
      <label>–ù–æ–≤–æ–µ –∏–º—è:</label><br><input type="text" name="name"><br><br>
      <label>–ù–æ–≤—ã–π email:</label><br><input type="email" name="emails"><br><br>
      <label>–ù–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è:</label><br><input type="text" name="position"><br><br>
      <label>–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞:</label><br><input type="text" name="note"><br><br>
      <button type="submit">–û–±–Ω–æ–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
    </form>
    <p id="updateResponse" style="font-weight: bold;"></p>
  </div>

  <div id="sendMessageBlock" style="display:none;">
    <h3>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
    <p>üì¨ –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ñ–æ—Ä–º–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è</p>
  </div>

  <div id="searchClientBlock" style="display:none;">
    <h3>–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞</h3>
    <form id="searchForm">
      <label>–ò–º—è –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label><br><input type="text" name="query"><br><br>
      <button type="submit">–ù–∞–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞</button>
    </form>
    <div id="searchResponse" style="font-weight: bold; margin-top:20px;"></div>
  </div>

  <script>
    function showForm(formId) {
      const forms = ['ticketFormBlock', 'clientFormBlock', 'updateClientBlock', 'sendMessageBlock', 'searchClientBlock'];
      forms.forEach(f => document.getElementById(f).style.display = 'none');
      document.getElementById(formId).style.display = 'block';
    }

    // üîÑ –ü–æ–∫–∞–∑ —Å–ø–∏–Ω–Ω–µ—Ä–∞
    function showSpinner(elementId, text = "–ó–∞–≥—Ä—É–∑–∫–∞...") {
      const el = document.getElementById(elementId);
      if (el) {
        el.innerHTML = `<span class="spinner"></span>${text}`;
      }
    }

    // ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    function setResult(elementId, html) {
      const el = document.getElementById(elementId);
      if (el) {
        el.innerHTML = html;
      }
    }

    document.getElementById('ticketForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(this));
      showSpinner('responseMessage', '–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞...');

      const res = await fetch('/create-ticket', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const text = await res.text();
      setResult('responseMessage', text);
    });

    document.getElementById('clientForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(this));
      showSpinner('clientResponse', '–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞...');

      const res = await fetch('/create-client', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const text = await res.text();
      setResult('clientResponse', text);
    });

    document.getElementById('updateForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(this));
      data.is_new_note = "true";
      showSpinner('updateResponse', '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞...');

      const res = await fetch('/update-client', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const text = await res.text();
      setResult('updateResponse', text);
    });

    document.getElementById('searchForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(this));
      data.search_type = "partial_match";
      showSpinner('searchResponse', '–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞...');

      const res = await fetch('/search-client', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const text = await res.text();
      setResult('searchResponse', text);
    });
  </script>
</body>
</html>
